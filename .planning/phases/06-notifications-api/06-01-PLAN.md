# Phase 6: Notifications API - Plan 01

**Created:** 2026-01-19
**Owner:** Person 3 (Engagement Lead)
**Status:** Ready to execute

## Objective

Implement the 3 TODO endpoints in `backend/app/api/notifications.py`:
1. `POST /send` - Send notification to a single user
2. `POST /send-bulk` - Send notifications to multiple users
3. `GET /user/{user_id}` - Get notification history for a user

## Execution Context

**Key files:**
- `backend/app/api/notifications.py` - Route handlers (TODOs here)
- `backend/app/services/notification_service.py` - Existing service with Twilio integration
- `backend/app/integrations/twilio_client.py` - SMS/WhatsApp client (already implemented)
- `backend/app/models/notification.py` - Pydantic schemas
- `backend/app/db/models.py` - Database models

**Existing infrastructure:**
- TwilioClient with `send_sms()` and `send_whatsapp()` methods
- NotificationService with specific notification methods (registration, match, reminder)
- User model has `phone` and `caregiver_phone` fields

## Tasks

### Task 1: Create Notification DB Model
**File:** `backend/app/db/models.py`

Add `Notification` model to store notification history:
- id (UUID, primary key)
- user_id (UUID, foreign key to users)
- message (Text)
- channel (String: 'sms' or 'whatsapp')
- status (String: 'sent', 'failed', 'pending')
- sent_at (DateTime)
- created_at (DateTime)

Add relationship to User model.

### Task 2: Update Notification Pydantic Schemas
**File:** `backend/app/models/notification.py`

Ensure NotificationResponse includes all fields from DB model.

### Task 3: Add Generic Send Method to NotificationService
**File:** `backend/app/services/notification_service.py`

Add method:
```python
async def send_notification(self, user_id: UUID, message: str, channel: str) -> Notification:
    # Fetch user
    # Validate phone exists
    # Send via TwilioClient based on channel
    # Create Notification record
    # Return notification
```

### Task 4: Implement POST /send Endpoint
**File:** `backend/app/api/notifications.py`

Replace TODO at line 29:
- Instantiate NotificationService
- Call `send_notification()`
- Return NotificationResponse

### Task 5: Implement POST /send-bulk Endpoint
**File:** `backend/app/api/notifications.py`

Replace TODO at line 50:
- Loop through user_ids
- Call `send_notification()` for each
- Track success/failure counts
- Return summary response

### Task 6: Implement GET /user/{user_id} Endpoint
**File:** `backend/app/api/notifications.py`

Replace TODO at line 67:
- Check authorization: current_user.id == user_id OR current_user is staff
- Query Notification table for user_id
- Return list of NotificationResponse

### Task 7: Write Tests
**File:** `backend/tests/unit/test_notification_service.py`

Test:
- send_notification with valid user
- send_notification with missing phone
- Authorization check for get_user_notifications

## Verification

```bash
# Run backend tests
cd backend && pytest tests/unit/test_notification_service.py -v

# Start backend and test endpoints manually
cd backend && uvicorn app.main:app --reload
```

Test with curl:
```bash
# Test send (requires valid user_id and staff auth)
curl -X POST http://localhost:8000/api/notifications/send \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"user_id": "<uuid>", "message": "Test", "channel": "sms"}'
```

## Success Criteria

- [ ] All 3 endpoints return real data instead of 501/empty
- [ ] Notifications are logged to database
- [ ] Authorization prevents users from viewing others' notifications
- [ ] Tests pass

## Output

- Modified: `backend/app/db/models.py`
- Modified: `backend/app/models/notification.py`
- Modified: `backend/app/services/notification_service.py`
- Modified: `backend/app/api/notifications.py`
- Created: `backend/tests/unit/test_notification_service.py`

---

*Plan: 06-01*
*Phase: 06-notifications-api*
