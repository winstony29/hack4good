---
phase: 05-person4-staff-api
plan: 01
type: execute
---

<objective>
Wire Staff API endpoints to use the existing AnalyticsService, replacing stub implementations with real database queries.

Purpose: Person 4 can complete this work independently while waiting for Person 2/3 to finish. The AnalyticsService is already fully implemented - the API endpoints just need to use it.
Output: Functional Staff API endpoints returning real data from database.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./05-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Key files:**
@backend/app/api/staff.py - Stub endpoints returning dummy data (needs wiring)
@backend/app/services/analytics_service.py - Fully implemented service (use this)
@backend/app/db/models.py - Activity, Registration, VolunteerMatch, User models

**Prior decisions:**
- Phase 02-04: Mock data in frontend charts - this phase wires backend to return real data
- Lazy imports pattern used in matches API (04-01) to avoid circular imports
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire get_analytics endpoint to AnalyticsService</name>
  <files>backend/app/api/staff.py</files>
  <action>
Import AnalyticsService at top of file. In get_analytics endpoint:
1. Instantiate AnalyticsService with db session
2. Call get_dashboard_metrics() for base metrics
3. Call get_weekly_trends() for weekly_registrations array
4. Merge results into response dict

Replace the hardcoded zeros with actual service calls. Keep the existing response shape for frontend compatibility.
  </action>
  <verify>curl -X GET http://localhost:8000/api/staff/analytics -H "Authorization: Bearer {token}" returns non-zero values when data exists</verify>
  <done>get_analytics returns real metrics from database via AnalyticsService</done>
</task>

<task type="auto">
  <name>Task 2: Wire get_activity_attendance endpoint</name>
  <files>backend/app/api/staff.py</files>
  <action>
1. Add Activity import to support fetching activity details
2. In get_activity_attendance endpoint:
   - Query Activity by activity_id, raise 404 if not found
   - Call analytics_service.get_activity_attendance(str(activity_id))
   - Add activity details to response (id, title, date, start_time, end_time, location)
3. Return combined response with activity + participants + volunteers

Use lazy import pattern from 04-01 if circular import issues occur.
  </action>
  <verify>curl -X GET http://localhost:8000/api/staff/attendance/{activity_id} returns activity details with participant/volunteer lists</verify>
  <done>get_activity_attendance returns real attendance data with activity details</done>
</task>

<task type="auto">
  <name>Task 3: Implement CSV export with real data</name>
  <files>backend/app/api/staff.py</files>
  <action>
In export_attendance_csv endpoint:
1. Query Activity by activity_id, raise 404 if not found
2. Get attendance via analytics_service.get_activity_attendance()
3. Build CSV content with headers: Name,Email,Phone,Role,Registration Time
4. Iterate participants (role=Participant) and volunteers (role=Volunteer)
5. Format registration time from Registration.created_at for participants
6. Format matched_at from VolunteerMatch for volunteers
7. Return Response with proper CSV content and headers

For registration times, need to query Registration/VolunteerMatch directly to get timestamps.
  </action>
  <verify>curl -X GET http://localhost:8000/api/staff/attendance/{activity_id}/export -o test.csv && cat test.csv shows real data rows</verify>
  <done>CSV export contains real participant/volunteer data with timestamps</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 endpoints return real data (not zeros/empty)
- [ ] 404 returned for invalid activity_id on attendance endpoints
- [ ] CSV export downloads with correct headers and data
- [ ] No import errors or circular dependencies
- [ ] Existing tests still pass (if any)
</verification>

<success_criteria>

- All endpoints use AnalyticsService instead of stub responses
- Response shapes unchanged (frontend compatibility)
- Proper error handling (404 for missing activities)
- CSV export functional with real timestamps
</success_criteria>

<output>
After completion, create `.planning/phases/05-person4-staff-api/05-01-SUMMARY.md`:

# Phase 5 Plan 1: Staff API Wiring Summary

**[One-liner about what was accomplished]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `backend/app/api/staff.py` - Wired to AnalyticsService

## Decisions Made

[Any decisions about implementation approach]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Phase 5 Plan 2 (weekly report endpoint) or Phase complete if no more plans.
</output>
