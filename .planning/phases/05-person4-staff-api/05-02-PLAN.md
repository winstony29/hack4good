---
phase: 05-person4-staff-api
plan: 02
type: execute
---

<objective>
Implement the weekly report endpoint with date range filtering and program breakdown.

Purpose: Complete the staff reporting functionality for activity summaries over custom date ranges.
Output: Functional /reports/weekly endpoint returning aggregated statistics.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./05-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-person4-staff-api/05-01-SUMMARY.md

**Key files:**
@backend/app/api/staff.py - Weekly report endpoint (stub)
@backend/app/services/analytics_service.py - Has get_program_breakdown(), needs date range methods

**Dependencies:**
- 05-01 must be complete (staff.py imports established)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add date-range methods to AnalyticsService</name>
  <files>backend/app/services/analytics_service.py</files>
  <action>
Add two new methods to AnalyticsService:

1. get_activities_in_range(start_date: date, end_date: date) -> int
   - Count activities where date >= start_date AND date <= end_date

2. get_registrations_in_range(start_date: date, end_date: date) -> Dict
   - Count participants (registrations with confirmed status)
   - Count volunteers (volunteer_matches with confirmed status)
   - Return {"participants": int, "volunteers": int}

3. get_program_breakdown_in_range(start_date: date, end_date: date) -> Dict[str, int]
   - Like existing get_program_breakdown() but filtered by date range
   - Group activities by program_type, count each

Use same query patterns as existing methods. Filter by Activity.date for date range.
  </action>
  <verify>Unit test or manual verification that methods return correct counts for date ranges</verify>
  <done>Three new methods added to AnalyticsService for date-range queries</done>
</task>

<task type="auto">
  <name>Task 2: Wire get_weekly_report endpoint</name>
  <files>backend/app/api/staff.py</files>
  <action>
In get_weekly_report endpoint:
1. Instantiate AnalyticsService with db session
2. Call get_activities_in_range(start_date, end_date) for activities_count
3. Call get_registrations_in_range(start_date, end_date) for participant/volunteer counts
4. Call get_program_breakdown_in_range(start_date, end_date) for program_breakdown

Return response matching existing shape:
{
    "start_date": start_date,
    "end_date": end_date,
    "activities_count": int,
    "participants_count": int,
    "volunteers_count": int,
    "program_breakdown": {"Art": 5, "Music": 3, ...}
}

Validate start_date <= end_date, return 400 if invalid range.
  </action>
  <verify>curl -X GET "http://localhost:8000/api/staff/reports/weekly?start_date=2024-01-01&end_date=2024-01-07" returns aggregated data</verify>
  <done>Weekly report endpoint returns real aggregated statistics for date range</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] AnalyticsService has 3 new date-range methods
- [ ] Weekly report returns real counts (not zeros)
- [ ] Date validation works (400 for invalid range)
- [ ] Program breakdown shows actual activity types
- [ ] No regressions in other staff endpoints
</verification>

<success_criteria>

- Weekly report endpoint fully functional
- Date range filtering accurate
- Program breakdown reflects actual data
- Error handling for invalid date ranges
</success_criteria>

<output>
After completion, create `.planning/phases/05-person4-staff-api/05-02-SUMMARY.md`
</output>
